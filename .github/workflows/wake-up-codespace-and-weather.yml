name: Wake Up Codespace, Weather Alert and Todo Summary

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š7:22 UTCè¿è¡Œï¼Œå”¤é†’Codespace
    - cron: '22 7 * * *'
    # æ¯å¤©æ—©ä¸Š7:30 UTCè¿è¡Œï¼Œæ‰§è¡Œå¤©æ°”é¢„æŠ¥å’Œå¾…åŠäº‹é¡¹æ±‡æ€»ï¼ˆæ­¤æ—¶Codespaceåº”è¯¥å·²è¢«å”¤é†’ï¼‰
    - cron: '30 7 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  wake-up-codespace:
    runs-on: ubuntu-latest
    # åœ¨æ‰‹åŠ¨è§¦å‘æˆ–å®šæ—¶è§¦å‘æ—¶éƒ½è¿è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '22 7 * * *' }}
    
    steps:
    - name: Wake up Codespace
      run: |
        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†Codespace URL
        if [ -z "${{ secrets.CODESPACE_URL }}" ]; then
          echo "CODESPACE_URL secret not configured. Please set it in repository secrets."
          echo "Example: https://your-codespace-name-3000.app.github.dev"
          exit 1
        fi
        
        echo "Attempting to wake up Codespace at ${{ secrets.CODESPACE_URL }}"
        
        # å°è¯•è®¿é—®Codespaceä¸»é¡µï¼Œæœ€å¤šé‡è¯•3æ¬¡
        for i in {1..3}; do
          echo "Attempt $i to wake up Codespace..."
          RESPONSE=$(curl -s -o response_body.txt -w "%{http_code}" "${{ secrets.CODESPACE_URL }}")
          
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
            echo "Codespace responded with HTTP $RESPONSE - considered awake"
            cat response_body.txt
            break
          else
            echo "Attempt $i failed with HTTP $RESPONSE"
            cat response_body.txt
            if [ $i -lt 3 ]; then
              echo "Waiting 30 seconds before retry..."
              sleep 30
            else
              echo "All attempts to wake up Codespace failed"
            fi
          fi
        done

  weather-and-todo-alert:
    runs-on: ubuntu-latest
    # åœ¨æ‰‹åŠ¨è§¦å‘æˆ–å®šæ—¶è§¦å‘æ—¶éƒ½è¿è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '30 7 * * *' }}
    
    steps:
    - name: Set timezone and check date
      run: |
        # è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´
        echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
        echo "DATE_TODAY=$(TZ=Asia/Shanghai date +%Y-%m-%d)" >> $GITHUB_ENV
        
    - name: Determine weather location based on schedule
      run: |
        # æ£€æŸ¥å½“å‰æ—¥æœŸï¼Œå†³å®šæ˜¯å¦è¿˜åœ¨é˜²åŸæ¸¯å¤©æ°”é¢„æŠ¥æœŸé—´ï¼ˆæˆªè‡³2026-02-05ï¼‰
        CURRENT_DATE=$(TZ=Asia/Shanghai date +%Y-%m-%d)
        END_DATE="2026-02-05"
        
        if [[ "$CURRENT_DATE" < "$END_DATE" ]]; then
          echo "Sending Fangchenggang weather (temporary period)"
          echo "CITY_URL=é˜²åŸæ¸¯" >> $GITHUB_ENV
          echo "CITY_DISPLAY=å¹¿è¥¿é˜²åŸæ¸¯" >> $GITHUB_ENV
        else
          echo "Sending Shanghai weather (default location)"
          echo "CITY_URL=ä¸Šæµ·" >> $GITHUB_ENV
          echo "CITY_DISPLAY=ä¸Šæµ·" >> $GITHUB_ENV
        fi
        echo "Weather location: ${{ env.CITY_DISPLAY }}"
        
    - name: Get Detailed Weather Information
      id: get_weather
      run: |
        # è·å–æŒ‡å®šåŸå¸‚çš„è¯¦ç»†å¤©æ°”é¢„æŠ¥
        # å½“å‰å¤©æ°”
        CURRENT_WEATHER=$(curl -s "wttr.in/${{ env.CITY_URL }}?format=1&lang=zh")
        echo "current_weather=$CURRENT_WEATHER" >> $GITHUB_OUTPUT
        
        # è·å–å®Œæ•´é¢„æŠ¥
        FULL_FORECAST=$(curl -s "wttr.in/${{ env.CITY_URL }}?T&lang=zh")
        echo "full_forecast<<EOF" >> $GITHUB_OUTPUT
        echo "$FULL_FORECAST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # ä¿å­˜åˆ°æ–‡ä»¶ä»¥ä¾¿è¿›ä¸€æ­¥å¤„ç†
        echo "$FULL_FORECAST" > weather_report.txt
        
    - name: Get Pending Todos from Todo App
      id: get_todos
      run: |
        # ä»Todoåº”ç”¨è·å–å¾…åŠäº‹é¡¹
        TODO_APP_URL="${{ secrets.CODESPACE_URL }}"
        # å°†URLè½¬æ¢ä¸ºç«¯å£3000çš„æ ¼å¼ï¼Œç”¨äºè®¿é—®Todoåº”ç”¨
        TODO_APP_API="${TODO_APP_URL/18789/3000}/api/todos/pending"
        
        echo "Fetching pending todos from: $TODO_APP_API"
        
        # å°è¯•è·å–å¾…åŠäº‹é¡¹ï¼Œè®¾ç½®è¶…æ—¶
        TIMEOUT_SECONDS=10
        COUNT=0
        MAX_COUNT=3
        
        while [ $COUNT -lt $MAX_COUNT ]; do
          TODO_RESPONSE=$(curl -s --max-time $TIMEOUT_SECONDS "$TODO_APP_API" -w "\nHTTP_CODE:%{http_code}")
          HTTP_CODE=$(echo "$TODO_RESPONSE" | tail -n1 | cut -d: -f2)
          TODO_DATA=$(echo "$TODO_RESPONSE" | sed '$d')  # ç§»é™¤æœ€åä¸€è¡ŒHTTP_CODE
        
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Successfully fetched todos"
            echo "pending_todos=$TODO_DATA" >> $GITHUB_OUTPUT
            echo "$TODO_DATA" > pending_todos.json
            break
          else
            echo "Failed to fetch todos, HTTP code: $HTTP_CODE"
            COUNT=$((COUNT + 1))
            if [ $COUNT -lt $MAX_COUNT ]; then
              echo "Retrying in 5 seconds... ($COUNT/$MAX_COUNT)"
              sleep 5
            else
              echo "Failed to fetch todos after $MAX_COUNT attempts"
              echo "pending_todos=[]" >> $GITHUB_OUTPUT
              echo "[]" > pending_todos.json
            fi
          fi
        done
        
    - name: Process and Display Combined Report
      run: |
        echo "==============================================="
        echo "ğŸŒ¤ï¸ã€${{ env.CITY_DISPLAY }}å¤©æ°”é¢„æŠ¥ã€‘"
        echo "ğŸ• æ—¶é—´: $(TZ=Asia/Shanghai date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
        echo "==============================================="
        echo "å½“å‰å¤©æ°”: ${{ steps.get_weather.outputs.current_weather }}"
        echo ""
        
        # æå–å…³é”®ä¿¡æ¯
        TEMP_LINE=$(grep -A 10 "å¤©æ°”é¢„æŠ¥:" weather_report.txt | head -n 5)
        echo "ğŸŒ¡ï¸ æ¸©åº¦è¯¦æƒ…:"
        echo "$TEMP_LINE"
        echo ""
        
        # æ˜å¤©é¢„æŠ¥
        TOMORROW=$(sed -n '/.*æ˜ŸæœŸäº”.*/,/.*æ˜ŸæœŸå…­.*/p' weather_report.txt | head -n -1)
        if [ -z "$TOMORROW" ]; then
          TOMORROW=$(sed -n '/.*Friday.*/,/.*Saturday.*/p' weather_report.txt | head -n -1)
        fi
        if [ ! -z "$TOMORROW" ]; then
          echo "ğŸ“… æ˜å¤©é¢„æŠ¥:"
          echo "$TOMORROW"
        fi
        echo ""
        
        # æ˜¾ç¤ºå¾…åŠäº‹é¡¹
        echo "ğŸ“‹ã€ä»Šæ—¥å¾…åŠäº‹é¡¹ã€‘"
        PENDING_TODOS=$(cat pending_todos.json)
        TODO_COUNT=$(echo "$PENDING_TODOS" | jq -r 'length' 2>/dev/null || echo "0")
        
        if [ "$TODO_COUNT" = "0" ] || [ "$PENDING_TODOS" = "null" ]; then
          echo "ğŸ‰ æ²¡æœ‰å¾…åŠäº‹é¡¹ï¼Œäº«å—ç¾å¥½çš„ä¸€å¤©å§ï¼"
        else
          echo "æ‚¨æœ‰ $TODO_COUNT é¡¹å¾…åŠä»»åŠ¡ï¼š"
          echo "$PENDING_TODOS" | jq -r '.[] | "â€¢ \(.text)"' 2>/dev/null || echo "æ— æ³•è§£æå¾…åŠäº‹é¡¹æ•°æ®"
        fi
        echo ""
        echo "==============================================="
        
    - name: Archive Reports
      uses: actions/upload-artifact@v4
      with:
        name: daily-report-${{ env.DATE_TODAY }}
        path: |
          weather_report.txt
          pending_todos.json