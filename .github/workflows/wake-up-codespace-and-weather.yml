name: Wake Up Codespace and Weather Alert

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š7:22 UTCè¿è¡Œï¼Œå”¤é†’Codespace
    - cron: '22 7 * * *'
    # æ¯å¤©æ—©ä¸Š7:30 UTCè¿è¡Œï¼Œæ‰§è¡Œå¤©æ°”é¢„æŠ¥ï¼ˆæ­¤æ—¶Codespaceåº”è¯¥å·²è¢«å”¤é†’ï¼‰
    - cron: '30 7 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  wake-up-codespace:
    runs-on: ubuntu-latest
    # åœ¨æ‰‹åŠ¨è§¦å‘æˆ–å®šæ—¶è§¦å‘æ—¶éƒ½è¿è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '22 7 * * *' }}
    
    steps:
    - name: Wake up Codespace
      run: |
        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†Codespace URL
        if [ -z "${{ secrets.CODESPACE_URL }}" ]; then
          echo "CODESPACE_URL secret not configured. Please set it in repository secrets."
          echo "Example: https://your-codespace-name-3000.app.github.dev"
          exit 1
        fi
        
        echo "Attempting to wake up Codespace at ${{ secrets.CODESPACE_URL }}"
        
        # å°è¯•è®¿é—®Codespaceä¸»é¡µï¼Œæœ€å¤šé‡è¯•3æ¬¡
        for i in {1..3}; do
          echo "Attempt $i to wake up Codespace..."
          RESPONSE=$(curl -s -o response_body.txt -w "%{http_code}" "${{ secrets.CODESPACE_URL }}")
          
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
            echo "Codespace responded with HTTP $RESPONSE - considered awake"
            cat response_body.txt
            break
          else
            echo "Attempt $i failed with HTTP $RESPONSE"
            cat response_body.txt
            if [ $i -lt 3 ]; then
              echo "Waiting 30 seconds before retry..."
              sleep 30
            else
              echo "All attempts to wake up Codespace failed"
            fi
          fi
        done

  weather-alert:
    runs-on: ubuntu-latest
    # åœ¨æ‰‹åŠ¨è§¦å‘æˆ–å®šæ—¶è§¦å‘æ—¶éƒ½è¿è¡Œ
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.schedule == '30 7 * * *' }}
    
    steps:
    - name: Set timezone and check date
      run: |
        # è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´
        echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
        echo "DATE_TODAY=$(TZ=Asia/Shanghai date +%Y-%m-%d)" >> $GITHUB_ENV
        
    - name: Determine weather location based on schedule
      run: |
        # æ£€æŸ¥å½“å‰æ—¥æœŸï¼Œå†³å®šæ˜¯å¦è¿˜åœ¨é˜²åŸæ¸¯å¤©æ°”é¢„æŠ¥æœŸé—´ï¼ˆæˆªè‡³2026-02-05ï¼‰
        CURRENT_DATE=$(TZ=Asia/Shanghai date +%Y-%m-%d)
        END_DATE="2026-02-05"
        
        if [[ "$CURRENT_DATE" < "$END_DATE" ]]; then
          echo "Sending Fangchenggang weather (temporary period)"
          echo "CITY_URL=é˜²åŸæ¸¯" >> $GITHUB_ENV
          echo "CITY_DISPLAY=å¹¿è¥¿é˜²åŸæ¸¯" >> $GITHUB_ENV
        else
          echo "Sending Shanghai weather (default location)"
          echo "CITY_URL=ä¸Šæµ·" >> $GITHUB_ENV
          echo "CITY_DISPLAY=ä¸Šæµ·" >> $GITHUB_ENV
        fi
        echo "Weather location: ${{ env.CITY_DISPLAY }}"
        
    - name: Get Detailed Weather Information
      id: get_weather
      run: |
        # è·å–æŒ‡å®šåŸå¸‚çš„è¯¦ç»†å¤©æ°”é¢„æŠ¥
        # å½“å‰å¤©æ°”
        CURRENT_WEATHER=$(curl -s "wttr.in/${{ env.CITY_URL }}?format=1&lang=zh")
        echo "current_weather=$CURRENT_WEATHER" >> $GITHUB_OUTPUT
        
        # è·å–å®Œæ•´é¢„æŠ¥
        FULL_FORECAST=$(curl -s "wttr.in/${{ env.CITY_URL }}?T&lang=zh")
        echo "full_forecast<<EOF" >> $GITHUB_OUTPUT
        echo "$FULL_FORECAST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # ä¿å­˜åˆ°æ–‡ä»¶ä»¥ä¾¿è¿›ä¸€æ­¥å¤„ç†
        echo "$FULL_FORECAST" > weather_report.txt
        
    - name: Process and Display Weather Report
      run: |
        echo "==============================================="
        echo "ğŸŒ¤ï¸ã€${{ env.CITY_DISPLAY }}å¤©æ°”é¢„æŠ¥ã€‘"
        echo "ğŸ• æ—¶é—´: $(TZ=Asia/Shanghai date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
        echo "==============================================="
        echo "å½“å‰å¤©æ°”: ${{ steps.get_weather.outputs.current_weather }}"
        echo ""
        
        # æå–å…³é”®ä¿¡æ¯
        TEMP_LINE=$(grep -A 10 "å¤©æ°”é¢„æŠ¥:" weather_report.txt | head -n 5)
        echo "ğŸŒ¡ï¸ æ¸©åº¦è¯¦æƒ…:"
        echo "$TEMP_LINE"
        echo ""
        
        # æ˜å¤©é¢„æŠ¥
        TOMORROW=$(sed -n '/.*æ˜ŸæœŸäº”.*/,/.*æ˜ŸæœŸå…­.*/p' weather_report.txt | head -n -1)
        if [ -z "$TOMORROW" ]; then
          TOMORROW=$(sed -n '/.*Friday.*/,/.*Saturday.*/p' weather_report.txt | head -n -1)
        fi
        if [ ! -z "$TOMORROW" ]; then
          echo "ğŸ“… æ˜å¤©é¢„æŠ¥:"
          echo "$TOMORROW"
        fi
        echo ""
        echo "==============================================="
        
    - name: Archive Weather Report
      uses: actions/upload-artifact@v4
      with:
        name: weather-report-${{ env.DATE_TODAY }}
        path: weather_report.txt